'use client';

import { useState, useEffect, useMemo } from 'react';
import { usePathname } from 'next/navigation';
import BackButton from '@/components/BackButton';
import { findMbcbRow } from '@/lib/mbcbData';
import jsPDF from 'jspdf';
import { useDebounce } from '@/hooks/useDebounce';

type PartInput = {
  thickness?: number;
  length?: number | null;
  coatingGsm?: number;
};

type PartResult = {
  found: boolean;
  error?: string;
  weightBlackMaterial?: number;
  weightZincAdded?: number;
  totalWeight?: number;
};

// Hardcoded dropdown values
const W_BEAM_THICKNESS = [2.0, 2.05, 2.1, 2.15, 2.2, 2.25, 2.3, 2.35, 2.4, 2.45, 2.5, 2.55, 2.6, 2.65, 2.7, 2.75, 2.8, 2.85, 2.9, 2.95, 3.0];
const W_BEAM_COATING = [350, 550];

const POST_THICKNESS = [4.0, 4.05, 4.1, 4.15, 4.2, 4.25, 4.3, 4.35, 4.4, 4.45, 4.5, 4.55, 4.6, 4.65, 4.7, 4.75, 4.8, 4.85, 4.9, 4.95, 5.0];
const POST_LENGTH = [1200, 1500, 1800];
const POST_COATING = [350, 550];

const SPACER_THICKNESS = [4.0, 4.05, 4.1, 4.15, 4.2, 4.25, 4.3, 4.35, 4.4, 4.45, 4.5, 4.55, 4.6, 4.65, 4.7, 4.75, 4.8, 4.85, 4.9, 4.95, 5.0];
const SPACER_LENGTH = [330, 360];
const SPACER_COATING = [350, 550];

// Helper function to format numbers in Indian numbering system
function formatIndianUnits(value: number): string {
  // Format with Indian comma style
  const formatted = value.toLocaleString('en-IN', { 
    minimumFractionDigits: 0, 
    maximumFractionDigits: 0 
  });

  // If less than 1 Lakh (1,00,000), return just the formatted number
  if (value < 100000) {
    return formatted;
  }

  // If >= 1 Lakh and < 1 Crore (1,00,00,000), return in Lakhs
  if (value >= 100000 && value < 10000000) {
    const lakhs = value / 100000;
    return `${lakhs.toFixed(1)} Lakhs`;
  }

  // If >= 1 Crore, return in Crores
  const crores = value / 10000000;
  return `${crores.toFixed(1)} Crores`;
}

export default function WBeamPage() {
  const pathname = usePathname();
  
  // Part selection toggles
  const [includeWBeam, setIncludeWBeam] = useState<boolean>(true);
  const [includePost, setIncludePost] = useState<boolean>(true);
  const [includeSpacer, setIncludeSpacer] = useState<boolean>(true);
  const [includeTransportation, setIncludeTransportation] = useState<boolean>(false);
  const [includeInstallation, setIncludeInstallation] = useState<boolean>(false);

  const [wBeam, setWBeam] = useState<PartInput>({
    thickness: W_BEAM_THICKNESS[0],
    coatingGsm: W_BEAM_COATING[0],
  });
  const [post, setPost] = useState<PartInput>({
    thickness: POST_THICKNESS[0],
    length: POST_LENGTH[0],
    coatingGsm: POST_COATING[0],
  });
  const [spacer, setSpacer] = useState<PartInput>({
    thickness: SPACER_THICKNESS[0],
    length: SPACER_LENGTH[0],
    coatingGsm: SPACER_COATING[0],
  });
  const [ratePerKg, setRatePerKg] = useState<number | null>(null);
  const [transportCostPerKg, setTransportCostPerKg] = useState<number | null>(null);
  const [installationCostPerRm, setInstallationCostPerRm] = useState<number | null>(null);
  const [quantityRm, setQuantityRm] = useState<number | null>(null);
  
  // Debounced values for calculations to prevent lag while typing
  const debouncedRatePerKg = useDebounce(ratePerKg, 300);
  const debouncedTransportCostPerKg = useDebounce(transportCostPerKg, 300);
  const debouncedInstallationCostPerRm = useDebounce(installationCostPerRm, 300);
  const debouncedQuantityRm = useDebounce(quantityRm, 300);

  // Results for each part
  const [wBeamResult, setWBeamResult] = useState<PartResult | null>(null);
  const [postResult, setPostResult] = useState<PartResult | null>(null);
  const [spacerResult, setSpacerResult] = useState<PartResult | null>(null);

  // Overall totals state
  const [totalBlackWeight, setTotalBlackWeight] = useState<number>(0);
  const [totalZincWeight, setTotalZincWeight] = useState<number>(0);
  const [totalWeight, setTotalWeight] = useState<number>(0);
  const [totalSetWeight, setTotalSetWeight] = useState<number>(0);

  // Function to update overall totals with multipliers and fasteners (Single W-Beam)
  // Single W-Beam: W-Beam × 1, Post × 2, Spacer × 2, Fasteners = 2 kg
  const updateOverallTotals = () => {
    // Get part weights (black + zinc) from confirmed results
    const wBeamWeight = includeWBeam && wBeamResult?.found ? (wBeamResult.totalWeight || 0) : 0;
    const postWeight = includePost && postResult?.found ? (postResult.totalWeight || 0) : 0;
    const spacerWeight = includeSpacer && spacerResult?.found ? (spacerResult.totalWeight || 0) : 0;
    
    // Calculate total set weight with multipliers
    // totalSetWeightKg = (1 × wBeamWeight) + (2 × postWeight) + (2 × spacerWeight) + 2
    const fastenersWeight = 2; // Fasteners = 2 kg for Single W-Beam
    const totalSetWeightKg = (1 * wBeamWeight) + (2 * postWeight) + (2 * spacerWeight) + fastenersWeight;
    
    // Total weight per running metre = totalSetWeightKg / 4
    const totalWeightPerRmKg = totalSetWeightKg / 4;
    
    // Calculate black and zinc totals for display (with multipliers)
    const wBeamBlack = includeWBeam && wBeamResult?.found ? (wBeamResult.weightBlackMaterial || 0) * 1 : 0;
    const wBeamZinc = includeWBeam && wBeamResult?.found ? (wBeamResult.weightZincAdded || 0) * 1 : 0;
    const postBlack = includePost && postResult?.found ? (postResult.weightBlackMaterial || 0) * 2 : 0;
    const postZinc = includePost && postResult?.found ? (postResult.weightZincAdded || 0) * 2 : 0;
    const spacerBlack = includeSpacer && spacerResult?.found ? (spacerResult.weightBlackMaterial || 0) * 2 : 0;
    const spacerZinc = includeSpacer && spacerResult?.found ? (spacerResult.weightZincAdded || 0) * 2 : 0;
    
    setTotalBlackWeight(wBeamBlack + postBlack + spacerBlack);
    setTotalZincWeight(wBeamZinc + postZinc + spacerZinc);
    setTotalSetWeight(totalSetWeightKg);
    setTotalWeight(totalWeightPerRmKg); // Store kgPerRm in totalWeight
  };

  // Reset all state when navigating to this page
  useEffect(() => {
    // Reset all form states to defaults
    setIncludeWBeam(true);
    setIncludePost(true);
    setIncludeSpacer(true);
    setIncludeTransportation(false);
    setIncludeInstallation(false);
    
    setWBeam({
      thickness: W_BEAM_THICKNESS[0],
      coatingGsm: W_BEAM_COATING[0],
    });
    setPost({
      thickness: POST_THICKNESS[0],
      length: POST_LENGTH[0],
      coatingGsm: POST_COATING[0],
    });
    setSpacer({
      thickness: SPACER_THICKNESS[0],
      length: SPACER_LENGTH[0],
      coatingGsm: SPACER_COATING[0],
    });
    
    setRatePerKg(null);
    setTransportCostPerKg(null);
    setInstallationCostPerRm(null);
    setQuantityRm(null);
    
    setWBeamResult(null);
    setPostResult(null);
    setSpacerResult(null);
    
    setTotalBlackWeight(0);
    setTotalZincWeight(0);
    setTotalWeight(0);
    setTotalSetWeight(0);
  }, [pathname]);

  // Update totals whenever any result or selection changes
  useEffect(() => {
    updateOverallTotals();
  }, [wBeamResult, postResult, spacerResult, includeWBeam, includePost, includeSpacer]);

  const handleConfirmWBeam = () => {
    if (!wBeam.thickness || !wBeam.coatingGsm) {
      setWBeamResult({
        found: false,
        error: 'Please select thickness and coating GSM',
      });
      return;
    }

    const row = findMbcbRow('W-Beam', wBeam.thickness, wBeam.coatingGsm, null, 'W-Beam Section');
    
    if (row) {
      const totalWeight = row.weightBlackMaterial + row.weightZincAdded;
      setWBeamResult({
        found: true,
        weightBlackMaterial: row.weightBlackMaterial,
        weightZincAdded: row.weightZincAdded,
        totalWeight,
      });
      // Totals will update automatically via useEffect
    } else {
      setWBeamResult({
        found: false,
        error: 'No matching entry found in master data for the selected values.',
      });
      // Totals will update automatically via useEffect
    }
  };

  const handleConfirmPost = () => {
    if (!post.thickness || !post.length || !post.coatingGsm) {
      setPostResult({
        found: false,
        error: 'Please select thickness, length, and coating GSM',
      });
      return;
    }

    const row = findMbcbRow('Post', post.thickness, post.coatingGsm, post.length, 'W-Beam Section');
    
    if (row) {
      const totalWeight = row.weightBlackMaterial + row.weightZincAdded;
      setPostResult({
        found: true,
        weightBlackMaterial: row.weightBlackMaterial,
        weightZincAdded: row.weightZincAdded,
        totalWeight,
      });
      // Totals will update automatically via useEffect
    } else {
      setPostResult({
        found: false,
        error: 'No matching entry found in master data for the selected values.',
      });
      // Totals will update automatically via useEffect
    }
  };

  const handleConfirmSpacer = () => {
    if (!spacer.thickness || !spacer.length || !spacer.coatingGsm) {
      setSpacerResult({
        found: false,
        error: 'Please select thickness, length, and coating GSM',
      });
      return;
    }

    const row = findMbcbRow('Spacer', spacer.thickness, spacer.coatingGsm, spacer.length, 'W-Beam Section');
    
    if (row) {
      const totalWeight = row.weightBlackMaterial + row.weightZincAdded;
      setSpacerResult({
        found: true,
        weightBlackMaterial: row.weightBlackMaterial,
        weightZincAdded: row.weightZincAdded,
        totalWeight,
      });
      // Totals will update automatically via useEffect
    } else {
      setSpacerResult({
        found: false,
        error: 'No matching entry found in master data for the selected values.',
      });
      // Totals will update automatically via useEffect
    }
  };

  // Memoized cost calculations to prevent unnecessary recalculations
  const costCalculations = useMemo(() => {
    // kgPerRm is stored in totalWeight
    const kgPerRm = totalWeight;
    
    const transportCostPerKgValue = includeTransportation && debouncedTransportCostPerKg && debouncedTransportCostPerKg > 0 ? debouncedTransportCostPerKg : 0;
    const installationCostPerRmValue = includeInstallation && debouncedInstallationCostPerRm && debouncedInstallationCostPerRm > 0 ? debouncedInstallationCostPerRm : 0;
    
    const materialCostPerRm = debouncedRatePerKg && debouncedRatePerKg > 0 && kgPerRm > 0 ? kgPerRm * debouncedRatePerKg : null;
    const transportCostPerRm = kgPerRm > 0 ? kgPerRm * transportCostPerKgValue : null;
    
    // Calculate total cost per rm
    const totalCostPerRm = materialCostPerRm !== null
      ? materialCostPerRm + (transportCostPerRm || 0) + installationCostPerRmValue
      : null;
    
    // Calculate final total based on quantity
    const finalTotal = totalCostPerRm !== null && debouncedQuantityRm !== null && debouncedQuantityRm > 0
      ? totalCostPerRm * debouncedQuantityRm
      : null;
    
    return {
      materialCostPerRm,
      transportCostPerRm,
      installationCostPerRmValue,
      totalCostPerRm,
      finalTotal
    };
  }, [totalWeight, debouncedRatePerKg, debouncedTransportCostPerKg, debouncedInstallationCostPerRm, debouncedQuantityRm, includeTransportation, includeInstallation]);
  
  const { materialCostPerRm, transportCostPerRm, installationCostPerRmValue, totalCostPerRm, finalTotal } = costCalculations;

  // PDF Generation Function
  const generatePDF = async () => {
    const doc = new jsPDF();
    
    // Use Helvetica font (built-in, clean and professional)
    doc.setFont('helvetica');
    
    // Page dimensions and margins
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const marginLeft = 40;
    const marginRight = pageWidth - 40;
    const contentWidth = marginRight - marginLeft;
    const lineHeight = 14; // Standard line height
    
    let yPos = 40; // Start with top margin
    
    // Helper function to add separator line with proper spacing
    const addSeparator = (y: number) => {
      yPos = y + 12; // 12px spacing before separator
      doc.setDrawColor(204, 204, 204); // #CCCCCC grey
      doc.setLineWidth(1.2);
      doc.line(marginLeft, yPos, marginRight, yPos);
      yPos += 14; // 14px spacing after separator
      return yPos;
    };
    
    // Helper function to add vertical spacing
    const addSpacing = (currentY: number, spacing: number = lineHeight) => {
      return currentY + spacing;
    };
    
    // ============================================
    // HEADER LAYOUT: Logo LEFT, Company CENTER, Date
    // ============================================
    
    let headerY = yPos;
    let logoHeight = 0;
    
    // Load and add logo on LEFT side
    try {
      const logoImg = new Image();
      logoImg.src = '/LOGO.png';
      await new Promise((resolve, reject) => {
        logoImg.onload = resolve;
        logoImg.onerror = reject;
      });
      
      // Logo size: 80-140px width (using 120px)
      const logoWidth = 120;
      logoHeight = (logoImg.height / logoImg.width) * logoWidth;
      doc.addImage(logoImg, 'PNG', marginLeft, headerY, logoWidth, logoHeight);
    } catch (error) {
      console.warn('Logo could not be loaded:', error);
    }
    
    // Company Name CENTERED
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
    const companyNameY = headerY + (logoHeight > 0 ? logoHeight / 3 : 0);
    doc.text('YNM SAFETY PVT LTD', pageWidth / 2, companyNameY, { align: 'center' });
    
    // Subtitle CENTERED
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    const subtitleY = companyNameY + 10;
    doc.text('Price Estimate & Material Breakdown', pageWidth / 2, subtitleY, { align: 'center' });
    
    // Date CENTERED below subtitle
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
    doc.setFontSize(11);
    const dateY = subtitleY + 8;
    doc.text(`Date: ${dateStr}`, pageWidth / 2, dateY, { align: 'center' });
    
    // Set yPos after header (use logo height or default)
    yPos = Math.max(headerY + logoHeight, dateY) + 25; // 25px spacing after header
    
    // Header separator
    yPos = addSeparator(yPos);
    
    // ============================================
    // SECTION A: Product Information
    // ============================================
    
    yPos += 25; // 25px spacing before section (20-30px range)
    
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('Product Information', marginLeft, yPos);
    yPos = addSpacing(yPos, 16);
    
    // Product Type
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('Product Type: W-Beam Section', marginLeft, yPos);
    yPos = addSpacing(yPos, 14);
    
    // Selected Parts
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('Selected Parts:', marginLeft, yPos);
    yPos = addSpacing(yPos, 12);
    
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    
    if (includeWBeam && wBeamResult?.found) {
      doc.setFont('helvetica', 'bold');
      doc.text('W-Beam', marginLeft, yPos);
      yPos = addSpacing(yPos, 10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Thickness: ${wBeam.thickness} mm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.text(`Coating: ${wBeam.coatingGsm} GSM`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.text(`Black Material Weight: ${wBeamResult.weightBlackMaterial?.toFixed(3)} kg/rm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.text(`Zinc Added Weight: ${wBeamResult.weightZincAdded?.toFixed(3)} kg/rm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.setFont('helvetica', 'bold');
      doc.text(`Total Weight: ${wBeamResult.totalWeight?.toFixed(3)} kg/rm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, 14);
    }
    
    if (includePost && postResult?.found) {
      doc.setFont('helvetica', 'bold');
      doc.text('Post', marginLeft, yPos);
      yPos = addSpacing(yPos, 10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Thickness: ${post.thickness} mm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.text(`Length: ${post.length} mm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.text(`Coating: ${post.coatingGsm} GSM`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.text(`Black Material Weight: ${postResult.weightBlackMaterial?.toFixed(3)} kg/rm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.text(`Zinc Added Weight: ${postResult.weightZincAdded?.toFixed(3)} kg/rm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.setFont('helvetica', 'bold');
      doc.text(`Total Weight: ${postResult.totalWeight?.toFixed(3)} kg/rm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, 14);
    }
    
    if (includeSpacer && spacerResult?.found) {
      doc.setFont('helvetica', 'bold');
      doc.text('Spacer', marginLeft, yPos);
      yPos = addSpacing(yPos, 10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Thickness: ${spacer.thickness} mm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.text(`Length: ${spacer.length} mm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.text(`Coating: ${spacer.coatingGsm} GSM`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.text(`Black Material Weight: ${spacerResult.weightBlackMaterial?.toFixed(3)} kg/rm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.text(`Zinc Added Weight: ${spacerResult.weightZincAdded?.toFixed(3)} kg/rm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
      doc.setFont('helvetica', 'bold');
      doc.text(`Total Weight: ${spacerResult.totalWeight?.toFixed(3)} kg/rm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, 14);
    }
    
    // Separator before weight breakdown
    yPos = addSeparator(yPos);
    
    // ============================================
    // SECTION B: Weight Breakdown
    // ============================================
    
    yPos += 25; // 25px spacing before section
    
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('Weight Breakdown', marginLeft, yPos);
    yPos = addSpacing(yPos, 14);
    
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    
    // Individual Part Weights
    doc.setFont('helvetica', 'bold');
    doc.text('Individual Part Weights (kg/rm):', marginLeft, yPos);
    yPos = addSpacing(yPos, 10);
    doc.setFont('helvetica', 'normal');
    
    if (includeWBeam && wBeamResult?.found) {
      doc.text(`W Beam: ${wBeamResult.totalWeight?.toFixed(3)} kg/rm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
    }
    if (includePost && postResult?.found) {
      doc.text(`Post: ${postResult.totalWeight?.toFixed(3)} kg/rm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
    }
    if (includeSpacer && spacerResult?.found) {
      doc.text(`Spacer: ${spacerResult.totalWeight?.toFixed(3)} kg/rm`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
    }
    
    yPos = addSpacing(yPos, 12);
    
    // Multipliers per Set
    doc.setFont('helvetica', 'bold');
    doc.text('Multipliers per Set:', marginLeft, yPos);
    yPos = addSpacing(yPos, 10);
    doc.setFont('helvetica', 'normal');
    
    if (includeWBeam && wBeamResult?.found) {
      doc.text(`W Beam × 1`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
    }
    if (includePost && postResult?.found) {
      doc.text(`Post × 2`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
    }
    if (includeSpacer && spacerResult?.found) {
      doc.text(`Spacer × 2`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
    }
    doc.text(`Fasteners = 2 kg`, marginLeft + 5, yPos);
    yPos = addSpacing(yPos, 12);
    
    // Total Weight per Set Calculation
    doc.setFont('helvetica', 'bold');
    doc.text('Total Weight per Set Calculation:', marginLeft, yPos);
    yPos = addSpacing(yPos, 10);
    doc.setFont('helvetica', 'normal');
    
    if (includeWBeam && wBeamResult?.found) {
      const wBeamCalc = (wBeamResult.totalWeight || 0) * 1;
      doc.text(`W Beam: ${wBeamResult.totalWeight?.toFixed(3)} × 1 = ${wBeamCalc.toFixed(3)} kg`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
    }
    if (includePost && postResult?.found) {
      const postCalc = (postResult.totalWeight || 0) * 2;
      doc.text(`Post: ${postResult.totalWeight?.toFixed(3)} × 2 = ${postCalc.toFixed(3)} kg`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
    }
    if (includeSpacer && spacerResult?.found) {
      const spacerCalc = (spacerResult.totalWeight || 0) * 2;
      doc.text(`Spacer: ${spacerResult.totalWeight?.toFixed(3)} × 2 = ${spacerCalc.toFixed(3)} kg`, marginLeft + 5, yPos);
      yPos = addSpacing(yPos, lineHeight);
    }
    doc.text(`Fasteners: 2.000 kg`, marginLeft + 5, yPos);
    yPos = addSpacing(yPos, 10);
    doc.setFont('helvetica', 'bold');
    doc.text(`Total Set Weight = ${totalSetWeight.toFixed(3)} kg/set`, marginLeft + 5, yPos);
    yPos = addSpacing(yPos, 12);
    
    // Weight per Running Metre
    doc.setFont('helvetica', 'normal');
    doc.text(`Total Weight per Running Metre = ${totalSetWeight.toFixed(3)} ÷ 4`, marginLeft + 5, yPos);
    yPos = addSpacing(yPos, 10);
    doc.setFont('helvetica', 'bold');
    doc.text(`Total Weight per Running Metre: ${totalWeight.toFixed(3)} kg/rm`, marginLeft + 5, yPos);
    yPos = addSpacing(yPos, 25);
    
    // Separator before cost breakdown
    yPos = addSeparator(yPos);
    
    // ============================================
    // SECTION C: Cost Breakdown (per running metre)
    // ============================================
    
    yPos += 25; // 25px spacing before section
    
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('Cost Breakdown (per running metre)', marginLeft, yPos);
    yPos = addSpacing(yPos, 14);
    
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    
    // Helper function for left-right aligned cost values with dots
    const addCostLine = (label: string, value: number | null, y: number) => {
      if (value !== null && value > 0) {
        const labelText = `${label} (per rm)`;
        const valueText = `Rs. ${value.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        // Calculate dots for alignment
        const labelWidth = doc.getTextWidth(labelText);
        const dotsStart = marginLeft + labelWidth + 5;
        const dotsEnd = marginRight - doc.getTextWidth(valueText) - 5;
        const dotsCount = Math.floor((dotsEnd - dotsStart) / 2);
        const dots = dotsCount > 0 ? '.'.repeat(dotsCount) : '  ';
        
        doc.text(labelText, marginLeft, y);
        doc.text(dots, dotsStart, y);
        doc.text(valueText, marginRight, y, { align: 'right' });
        return y + lineHeight;
      }
      return y;
    };
    
    yPos = addCostLine('Material Cost', materialCostPerRm, yPos);
    yPos = addCostLine('Transportation Cost', transportCostPerRm, yPos);
    if (includeInstallation && installationCostPerRmValue > 0) {
      yPos = addCostLine('Installation Cost', installationCostPerRmValue, yPos);
    }
    
    yPos = addSpacing(yPos, 12);
    yPos = addSeparator(yPos);
    
    if (totalCostPerRm !== null) {
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      const totalLabel = 'Total Cost per Running Metre';
      const totalValue = `Rs. ${totalCostPerRm.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      
      const labelWidth = doc.getTextWidth(totalLabel);
      const dotsStart = marginLeft + labelWidth + 5;
      const dotsEnd = marginRight - doc.getTextWidth(totalValue) - 5;
      const dotsCount = Math.floor((dotsEnd - dotsStart) / 2);
      const dots = dotsCount > 0 ? '.'.repeat(dotsCount) : '  ';
      
      doc.text(totalLabel, marginLeft, yPos);
      doc.text(dots, dotsStart, yPos);
      doc.text(totalValue, marginRight, yPos, { align: 'right' });
      yPos = addSpacing(yPos, 8);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`(${formatIndianUnits(totalCostPerRm)})`, marginRight, yPos, { align: 'right' });
      yPos = addSpacing(yPos, 25);
    }
    
    // ============================================
    // FINAL TOTAL BLOCK
    // ============================================
    
    if (quantityRm !== null && quantityRm > 0 && finalTotal !== null) {
      yPos = addSeparator(yPos);
      yPos += 25; // 25px spacing before section
      
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('Final Total', marginLeft, yPos);
      yPos = addSpacing(yPos, 14);
      
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      doc.text(`Quantity: ${quantityRm} running metres`, marginLeft, yPos);
      yPos = addSpacing(yPos, 14);
      
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      const finalValue = `Rs. ${finalTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      doc.text('Final Total:', marginLeft, yPos);
      doc.text(finalValue, marginRight, yPos, { align: 'right' });
      yPos = addSpacing(yPos, 10);
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      doc.text(`(${formatIndianUnits(finalTotal)})`, marginRight, yPos, { align: 'right' });
      yPos = addSpacing(yPos, 30);
    }
    
    // ============================================
    // SIGNATURE BLOCK (Bottom Right)
    // ============================================
    
    // Calculate signature position (bottom-right, with 50-80px space above)
    const signatureY = pageHeight - 100; // Leave space for footer + signature area
    const signatureX = marginRight; // Right-aligned signature block
    
    // Separator before signature area
    doc.setDrawColor(204, 204, 204);
    doc.setLineWidth(1.2);
    doc.line(marginLeft, signatureY - 20, marginRight, signatureY - 20);
    
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('Authorized Signatory', signatureX, signatureY, { align: 'right' });
    doc.setFont('helvetica', 'bold');
    doc.text('YNM Safety Pvt Ltd', signatureX, signatureY + 10, { align: 'right' });
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text('(Signature & Seal)', signatureX, signatureY + 20, { align: 'right' });
    
    // ============================================
    // FOOTER (Bottom Center)
    // ============================================
    
    const footerY = pageHeight - 30;
    
    doc.setFontSize(9);
    doc.setTextColor(119, 119, 119); // #777777
    doc.setFont('helvetica', 'normal');
    doc.text('© YNM Safety Pvt Ltd', pageWidth / 2, footerY, { align: 'center' });
    doc.setFontSize(8);
    doc.text('This is a computer-generated estimate. For official confirmation, contact YNM Safety administration.', pageWidth / 2, footerY + 8, { align: 'center', maxWidth: contentWidth });
    
    // Reset text color
    doc.setTextColor(0, 0, 0);
    
    // Download
    doc.save(`W-Beam-Estimate-${new Date().toISOString().split('T')[0]}.pdf`);
  };

  return (
    <div className="min-h-screen flex flex-col items-start py-12 pt-16 pb-32 relative">
      <div className="w-full max-w-6xl mx-auto px-4">
        <BackButton href="/mbcb" />

        {/* Header */}
        <div className="w-full flex flex-col items-center mb-20 title-glow fade-up">
          <h1 className="text-6xl md:text-8xl font-extrabold text-white mb-8 text-center tracking-tight drop-shadow-2xl text-neon-gold" style={{ 
            textShadow: '0 0 40px rgba(212, 166, 90, 0.4), 0 0 80px rgba(212, 166, 90, 0.2), 0 0 120px rgba(106, 90, 249, 0.1)',
            letterSpacing: '-0.02em'
          }}>
            W-Beam Section
          </h1>
          <p className="text-xl text-slate-200 text-center max-w-2xl mb-8">
            Enter parameters to fetch weights from master data.
          </p>
          <div className="gold-divider"></div>
        </div>

        {/* Part Selection Toggles */}
        <div className="glassmorphic-premium rounded-3xl p-12 mb-16 slide-up card-hover-gold">
          <h3 className="text-2xl font-extrabold text-white mb-8 drop-shadow-lg">Select Parts to Include</h3>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            <label className="flex items-center space-x-3 cursor-pointer group toggle-glow">
              <input
                type="checkbox"
                checked={includeWBeam}
                onChange={(e) => {
                  setIncludeWBeam(e.target.checked);
                  if (!e.target.checked) {
                    setWBeamResult(null);
                  }
                }}
                className="w-5 h-5 rounded border-white/30 bg-white/10 text-premium-gold focus:ring-2 focus:ring-premium-gold cursor-pointer transition-all"
              />
              <span className="text-slate-200 font-semibold group-hover:text-premium-gold transition-colors">Include W-Beam?</span>
            </label>
            <label className="flex items-center space-x-3 cursor-pointer group toggle-glow">
              <input
                type="checkbox"
                checked={includePost}
                onChange={(e) => {
                  setIncludePost(e.target.checked);
                  if (!e.target.checked) {
                    setPostResult(null);
                  }
                }}
                className="w-5 h-5 rounded border-white/30 bg-white/10 text-premium-gold focus:ring-2 focus:ring-premium-gold cursor-pointer transition-all"
              />
              <span className="text-slate-200 font-semibold group-hover:text-premium-gold transition-colors">Include Post?</span>
            </label>
            <label className="flex items-center space-x-3 cursor-pointer group toggle-glow">
              <input
                type="checkbox"
                checked={includeSpacer}
                onChange={(e) => {
                  setIncludeSpacer(e.target.checked);
                  if (!e.target.checked) {
                    setSpacerResult(null);
                  }
                }}
                className="w-5 h-5 rounded border-white/30 bg-white/10 text-premium-gold focus:ring-2 focus:ring-premium-gold cursor-pointer transition-all"
              />
              <span className="text-slate-200 font-semibold group-hover:text-premium-gold transition-colors">Include Spacer?</span>
            </label>
          </div>
        </div>

        {/* Input Cards */}
        <div className="space-y-10 mb-10">
          {/* W-Beam Card */}
          {includeWBeam && (
          <div className="glassmorphic-premium rounded-3xl p-12 animate-fade-up card-hover-gold">
            <h2 className="text-3xl font-extrabold text-white mb-3 drop-shadow-lg">W-Beam</h2>
            <p className="text-sm text-slate-300 mb-8">Enter parameters to fetch weights from master data.</p>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div>
                <label className="block text-sm font-semibold text-slate-200 mb-2">
                  Thickness (mm)
                </label>
                <select
                  value={wBeam.thickness || ''}
                  onChange={(e) => {
                    setWBeam({ ...wBeam, thickness: parseFloat(e.target.value) });
                    setWBeamResult(null);
                  }}
                  className="input-premium w-full px-6 py-4 text-white [&>option]:bg-[#1A103C] [&>option]:text-white"
                >
                  {W_BEAM_THICKNESS.map((val) => (
                    <option key={val} value={val}>
                      {val}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-semibold text-slate-200 mb-2">
                  Coating GSM (g/sq.m)
                </label>
                <select
                  value={wBeam.coatingGsm || ''}
                  onChange={(e) => {
                    setWBeam({ ...wBeam, coatingGsm: parseFloat(e.target.value) });
                    setWBeamResult(null);
                  }}
                  className="input-premium w-full px-6 py-4 text-white [&>option]:bg-[#1A103C] [&>option]:text-white"
                >
                  {W_BEAM_COATING.map((val) => (
                    <option key={val} value={val}>
                      {val}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <button
              onClick={handleConfirmWBeam}
              className="btn-premium-gold px-8 py-3 text-lg shimmer relative overflow-hidden"
              style={{
                boxShadow: '0 0 20px rgba(212, 166, 90, 0.3)',
              }}
            >
              Confirm
            </button>

            {/* W-Beam Results */}
            {wBeamResult && (
              <div className="mt-6 pt-6 border-t border-white/20">
                {wBeamResult.found ? (
                  <div className="space-y-2">
                    <p className="text-slate-200">
                      <span className="font-semibold">Weight of Black Material (kg/rm):</span>{' '}
                      <span className="text-white font-bold">{wBeamResult.weightBlackMaterial?.toFixed(3)} kg/rm</span>
                    </p>
                    <p className="text-slate-200">
                      <span className="font-semibold">Weight of Zinc Added (kg/rm):</span>{' '}
                      <span className="text-white font-bold">{wBeamResult.weightZincAdded?.toFixed(3)} kg/rm</span>
                    </p>
                    <p className="text-slate-200">
                      <span className="font-semibold">Total part weight (kg/rm):</span>{' '}
                      <span className="text-premium-gold font-extrabold text-xl drop-shadow-lg">{wBeamResult.totalWeight?.toFixed(3)} kg/rm</span>
                    </p>
                  </div>
                ) : (
                  <div className="bg-red-500/20 border border-red-400/50 rounded-xl p-4 backdrop-blur-sm">
                    <p className="text-red-200 text-sm font-medium">{wBeamResult.error}</p>
                  </div>
                )}
              </div>
            )}
          </div>
          )}

          {/* Post Card */}
          {includePost && (
          <div className="glassmorphic rounded-3xl p-10 animate-fade-up" style={{ animationDelay: '100ms' }}>
            <h2 className="text-3xl font-extrabold text-white mb-3 drop-shadow-lg">Post</h2>
            <p className="text-sm text-slate-300 mb-8">Enter parameters to fetch weights from master data.</p>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div>
                <label className="block text-sm font-semibold text-slate-200 mb-2">
                  Thickness (mm)
                </label>
                <select
                  value={post.thickness || ''}
                  onChange={(e) => {
                    setPost({ ...post, thickness: parseFloat(e.target.value) });
                    setPostResult(null);
                  }}
                  className="input-premium w-full px-6 py-4 text-white [&>option]:bg-[#1A103C] [&>option]:text-white"
                >
                  {POST_THICKNESS.map((val) => (
                    <option key={val} value={val}>
                      {val}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-semibold text-slate-200 mb-2">
                  Length (mm)
                </label>
                <select
                  value={post.length || ''}
                  onChange={(e) => {
                    setPost({ ...post, length: e.target.value ? parseFloat(e.target.value) : null });
                    setPostResult(null);
                  }}
                  className="input-premium w-full px-6 py-4 text-white [&>option]:bg-[#1A103C] [&>option]:text-white"
                >
                  {POST_LENGTH.map((val) => (
                    <option key={val} value={val}>
                      {val}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-semibold text-slate-200 mb-2">
                  Coating GSM (g/sq.m)
                </label>
                <select
                  value={post.coatingGsm || ''}
                  onChange={(e) => {
                    setPost({ ...post, coatingGsm: parseFloat(e.target.value) });
                    setPostResult(null);
                  }}
                  className="input-premium w-full px-6 py-4 text-white [&>option]:bg-[#1A103C] [&>option]:text-white"
                >
                  {POST_COATING.map((val) => (
                    <option key={val} value={val}>
                      {val}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <button
              onClick={handleConfirmPost}
              className="btn-premium-gold px-8 py-3 text-lg shimmer relative overflow-hidden"
              style={{
                boxShadow: '0 0 20px rgba(212, 166, 90, 0.3)',
              }}
            >
              Confirm
            </button>

            {/* Post Results */}
            {postResult && (
              <div className="mt-6 pt-6 border-t border-white/20">
                {postResult.found ? (
                  <div className="space-y-2">
                    <p className="text-slate-200">
                      <span className="font-semibold">Weight of Black Material (kg/rm):</span>{' '}
                      <span className="text-white font-bold">{postResult.weightBlackMaterial?.toFixed(3)} kg/rm</span>
                    </p>
                    <p className="text-slate-200">
                      <span className="font-semibold">Weight of Zinc Added (kg/rm):</span>{' '}
                      <span className="text-white font-bold">{postResult.weightZincAdded?.toFixed(3)} kg/rm</span>
                    </p>
                    <p className="text-slate-200">
                      <span className="font-semibold">Total part weight (kg/rm):</span>{' '}
                      <span className="text-premium-gold font-extrabold text-xl drop-shadow-lg">{postResult.totalWeight?.toFixed(3)} kg/rm</span>
                    </p>
                  </div>
                ) : (
                  <div className="bg-red-500/20 border border-red-400/50 rounded-xl p-4 backdrop-blur-sm">
                    <p className="text-red-200 text-sm font-medium">{postResult.error}</p>
                  </div>
                )}
              </div>
            )}
          </div>
          )}

          {/* Spacer Card */}
          {includeSpacer && (
          <div className="glassmorphic rounded-3xl p-10 animate-fade-up" style={{ animationDelay: '200ms' }}>
            <h2 className="text-3xl font-extrabold text-white mb-3 drop-shadow-lg">Spacer</h2>
            <p className="text-sm text-slate-300 mb-8">Enter parameters to fetch weights from master data.</p>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div>
                <label className="block text-sm font-semibold text-slate-200 mb-2">
                  Thickness (mm)
                </label>
                <select
                  value={spacer.thickness || ''}
                  onChange={(e) => {
                    setSpacer({ ...spacer, thickness: parseFloat(e.target.value) });
                    setSpacerResult(null);
                  }}
                  className="input-premium w-full px-6 py-4 text-white [&>option]:bg-[#1A103C] [&>option]:text-white"
                >
                  {SPACER_THICKNESS.map((val) => (
                    <option key={val} value={val}>
                      {val}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-semibold text-slate-200 mb-2">
                  Length (mm)
                </label>
                <select
                  value={spacer.length || ''}
                  onChange={(e) => {
                    setSpacer({ ...spacer, length: e.target.value ? parseFloat(e.target.value) : null });
                    setSpacerResult(null);
                  }}
                  className="input-premium w-full px-6 py-4 text-white [&>option]:bg-[#1A103C] [&>option]:text-white"
                >
                  {SPACER_LENGTH.map((val) => (
                    <option key={val} value={val}>
                      {val}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-semibold text-slate-200 mb-2">
                  Coating GSM (g/sq.m)
                </label>
                <select
                  value={spacer.coatingGsm || ''}
                  onChange={(e) => {
                    setSpacer({ ...spacer, coatingGsm: parseFloat(e.target.value) });
                    setSpacerResult(null);
                  }}
                  className="input-premium w-full px-6 py-4 text-white [&>option]:bg-[#1A103C] [&>option]:text-white"
                >
                  {SPACER_COATING.map((val) => (
                    <option key={val} value={val}>
                      {val}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <button
              onClick={handleConfirmSpacer}
              className="btn-premium-gold px-8 py-3 text-lg shimmer relative overflow-hidden"
              style={{
                boxShadow: '0 0 20px rgba(212, 166, 90, 0.3)',
              }}
            >
              Confirm
            </button>

            {/* Spacer Results */}
            {spacerResult && (
              <div className="mt-6 pt-6 border-t border-white/20">
                {spacerResult.found ? (
                  <div className="space-y-2">
                    <p className="text-slate-200">
                      <span className="font-semibold">Weight of Black Material (kg/rm):</span>{' '}
                      <span className="text-white font-bold">{spacerResult.weightBlackMaterial?.toFixed(3)} kg/rm</span>
                    </p>
                    <p className="text-slate-200">
                      <span className="font-semibold">Weight of Zinc Added (kg/rm):</span>{' '}
                      <span className="text-white font-bold">{spacerResult.weightZincAdded?.toFixed(3)} kg/rm</span>
                    </p>
                    <p className="text-slate-200">
                      <span className="font-semibold">Total part weight (kg/rm):</span>{' '}
                      <span className="text-premium-gold font-extrabold text-xl drop-shadow-lg">{spacerResult.totalWeight?.toFixed(3)} kg/rm</span>
                    </p>
                  </div>
                ) : (
                  <div className="bg-red-500/20 border border-red-400/50 rounded-xl p-4 backdrop-blur-sm">
                    <p className="text-red-200 text-sm font-medium">{spacerResult.error}</p>
                  </div>
                )}
              </div>
            )}
          </div>
          )}
        </div>

        {/* Cost Inputs */}
        <div className="glassmorphic-premium rounded-3xl p-14 animate-fade-up mb-20 card-hover-gold" style={{ animationDelay: '100ms' }}>
            <h2 className="text-3xl font-extrabold text-white mb-8 drop-shadow-lg">Cost Inputs</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-semibold text-slate-200 mb-2">
                  Rate per kg (₹/kg)
                </label>
                <input
                  type="number"
                  value={ratePerKg || ''}
                  onChange={(e) => setRatePerKg(e.target.value ? parseFloat(e.target.value) : null)}
                  placeholder="Enter rate per kg"
                  className="input-premium w-full md:w-1/2 px-6 py-4 text-white placeholder-slate-400"
                />
              </div>
              <div className="pt-4 border-t border-white/20">
                <label className="flex items-center space-x-3 cursor-pointer group mb-4">
                  <input
                    type="checkbox"
                    checked={includeTransportation}
                    onChange={(e) => {
                      setIncludeTransportation(e.target.checked);
                      if (!e.target.checked) {
                        setTransportCostPerKg(null);
                      }
                    }}
                    className="w-5 h-5 rounded border-white/30 bg-white/10 text-premium-gold focus:ring-2 focus:ring-premium-gold cursor-pointer"
                  />
                  <span className="text-slate-200 font-semibold group-hover:text-premium-gold transition-colors">Include Transportation Cost?</span>
                </label>
                {includeTransportation && (
                  <div className="mt-4">
                    <label className="block text-sm font-semibold text-slate-200 mb-2">
                      Transportation Cost per kg (₹/kg)
                    </label>
                    <input
                      type="number"
                      value={transportCostPerKg || ''}
                      onChange={(e) => setTransportCostPerKg(e.target.value ? parseFloat(e.target.value) : null)}
                      placeholder="Enter transportation cost per kg"
                      className="input-premium w-full md:w-1/2 px-6 py-4 text-white placeholder-slate-400"
                    />
                  </div>
                )}
              </div>
              <div className="pt-4 border-t border-white/20">
                <label className="flex items-center space-x-3 cursor-pointer group mb-4">
                  <input
                    type="checkbox"
                    checked={includeInstallation}
                    onChange={(e) => {
                      setIncludeInstallation(e.target.checked);
                      if (!e.target.checked) {
                        setInstallationCostPerRm(null);
                      }
                    }}
                    className="w-5 h-5 rounded border-white/30 bg-white/10 text-premium-gold focus:ring-2 focus:ring-premium-gold cursor-pointer"
                  />
                  <span className="text-slate-200 font-semibold group-hover:text-premium-gold transition-colors">Include Installation Cost?</span>
                </label>
                {includeInstallation && (
                  <div>
                    <label className="block text-sm font-semibold text-slate-200 mb-2">
                      Installation Cost per running meter (₹/rm)
                    </label>
                    <input
                      type="number"
                      value={installationCostPerRm || ''}
                      onChange={(e) => setInstallationCostPerRm(e.target.value ? parseFloat(e.target.value) : null)}
                      placeholder="Enter installation cost per running meter"
                      className="input-premium w-full md:w-1/2 px-6 py-4 text-white placeholder-slate-400"
                    />
                  </div>
                )}
              </div>
            </div>
          </div>

        {/* Weight Calculation Breakdown - Shows immediately when any part is confirmed */}
        {((includeWBeam && wBeamResult?.found) || (includePost && postResult?.found) || (includeSpacer && spacerResult?.found)) && totalWeight > 0 && (
          <div className="glassmorphic-premium rounded-3xl p-14 border-2 border-premium-gold/50 shadow-2xl slide-up mb-16 card-hover-gold" style={{ animationDelay: '200ms' }}>
            <h3 className="text-3xl font-extrabold text-white mb-8 drop-shadow-lg">Weight Calculation Breakdown</h3>
            
            {/* Individual Part Weights */}
            <div className="mb-8">
              <h4 className="text-xl font-bold text-white mb-4 border-b border-white/20 pb-2">Individual Part Weights</h4>
              <div className="space-y-3">
                {includeWBeam && wBeamResult?.found && (
                  <div className="flex justify-between items-center">
                    <span className="text-slate-300 font-medium">W Beam Weight (kg/rm)</span>
                    <span className="text-white font-bold text-lg">{wBeamResult.totalWeight?.toFixed(3)} kg/rm</span>
                  </div>
                )}
                {includePost && postResult?.found && (
                  <div className="flex justify-between items-center">
                    <span className="text-slate-300 font-medium">Post Weight (kg/rm)</span>
                    <span className="text-white font-bold text-lg">{postResult.totalWeight?.toFixed(3)} kg/rm</span>
                  </div>
                )}
                {includeSpacer && spacerResult?.found && (
                  <div className="flex justify-between items-center">
                    <span className="text-slate-300 font-medium">Spacer Weight (kg/rm)</span>
                    <span className="text-white font-bold text-lg">{spacerResult.totalWeight?.toFixed(3)} kg/rm</span>
                  </div>
                )}
              </div>
            </div>

            {/* Multipliers per Set */}
            <div className="mb-8 pt-6 border-t border-white/20">
              <h4 className="text-xl font-bold text-white mb-4 border-b border-white/20 pb-2">Multipliers per Set</h4>
              <div className="space-y-2 text-slate-200">
                {includeWBeam && wBeamResult?.found && (
                  <p className="font-medium">W Beam × 1</p>
                )}
                {includePost && postResult?.found && (
                  <p className="font-medium">Post × 2</p>
                )}
                {includeSpacer && spacerResult?.found && (
                  <p className="font-medium">Spacer × 2</p>
                )}
                <p className="font-medium text-premium-gold">Fasteners = 2 kg</p>
              </div>
            </div>

            {/* Total Weight per Set Calculation */}
            <div className="mb-8 pt-6 border-t border-white/20">
              <h4 className="text-xl font-bold text-white mb-4 border-b border-white/20 pb-2">Total Weight per Set</h4>
              <div className="bg-white/5 rounded-xl p-4 mb-4">
                <div className="text-slate-300 text-sm font-mono space-y-1">
                  {includeWBeam && wBeamResult?.found && (
                    <div>W Beam: {wBeamResult.totalWeight?.toFixed(3)} × 1 = {(wBeamResult.totalWeight || 0).toFixed(3)} kg</div>
                  )}
                  {includePost && postResult?.found && (
                    <div>Post: {postResult.totalWeight?.toFixed(3)} × 2 = {((postResult.totalWeight || 0) * 2).toFixed(3)} kg</div>
                  )}
                  {includeSpacer && spacerResult?.found && (
                    <div>Spacer: {spacerResult.totalWeight?.toFixed(3)} × 2 = {((spacerResult.totalWeight || 0) * 2).toFixed(3)} kg</div>
                  )}
                  <div>Fasteners: 2.000 kg</div>
                  <div className="pt-2 border-t border-white/20 mt-2 font-bold text-white">
                    Total Set Weight = {totalSetWeight.toFixed(3)} kg/set
                  </div>
                </div>
              </div>
            </div>

            {/* Weight per Running Metre */}
            <div className="pt-6 border-t border-white/20">
              <h4 className="text-xl font-bold text-white mb-4 border-b border-white/20 pb-2">Weight per Running Metre</h4>
              <div className="bg-white/5 rounded-xl p-4">
                <div className="text-slate-300 text-sm font-mono mb-2">
                  Total Weight per Running Metre = {totalSetWeight.toFixed(3)} ÷ 4
                </div>
                <div className="text-2xl font-extrabold text-premium-gold">
                  {totalWeight.toFixed(3)} kg/rm
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Overall Totals Section - Shows immediately when any part is confirmed */}
        {((includeWBeam && wBeamResult?.found) || (includePost && postResult?.found) || (includeSpacer && spacerResult?.found)) && totalWeight > 0 && (
          <div className="glassmorphic-premium rounded-3xl p-14 border-2 border-premium-gold/50 shadow-2xl slide-up mb-16 card-hover-gold" style={{ animationDelay: '250ms' }}>
            <h3 className="text-3xl font-extrabold text-white mb-8 drop-shadow-lg">Summary</h3>
            <div className="space-y-6">
              <div>
                <p className="text-slate-300 text-sm mb-2 font-medium">Total Black Material Weight</p>
                <p className="text-3xl font-bold text-white">{totalBlackWeight.toFixed(3)} kg/rm</p>
              </div>
              <div>
                <p className="text-slate-300 text-sm mb-2 font-medium">Total Zinc Weight</p>
                <p className="text-3xl font-bold text-white">{totalZincWeight.toFixed(3)} kg/rm</p>
              </div>
              <div>
                <p className="text-slate-300 text-sm mb-2 font-medium">Total Weight per Set</p>
                <p className="text-3xl font-bold text-white">{totalSetWeight.toFixed(3)} kg/set</p>
              </div>
              <div>
                <p className="text-slate-300 text-sm mb-2 font-medium">Total Weight per Running Metre</p>
                <p className="text-4xl font-extrabold text-premium-gold drop-shadow-lg">{totalWeight.toFixed(3)} kg/rm</p>
              </div>
            </div>
          </div>
        )}

        {/* Comparison Card - Per rm vs Total */}
        {totalWeight > 0 && ratePerKg !== null && ratePerKg > 0 && (
          <div className="glassmorphic-premium rounded-3xl p-14 border-2 border-premium-gold/50 shadow-2xl slide-up mb-16 card-hover-gold" style={{ animationDelay: '300ms' }}>
            <h3 className="text-3xl font-extrabold text-white mb-8 drop-shadow-lg text-center">Cost Comparison</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              {/* Left Side: Cost Per Running Metre */}
              <div className="space-y-4">
                <h4 className="text-xl font-bold text-white mb-4 border-b border-white/20 pb-2">Cost Per Running Metre</h4>
                {materialCostPerRm !== null && materialCostPerRm > 0 && (
                  <div>
                    <p className="text-slate-300 text-sm mb-1">Material Cost</p>
                    <p className="text-xl font-bold text-white">
                      ₹{materialCostPerRm.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} /rm
                    </p>
                  </div>
                )}
                {transportCostPerRm !== null && transportCostPerRm > 0 && (
                  <div>
                    <p className="text-slate-300 text-sm mb-1">Transportation Cost</p>
                    <p className="text-xl font-bold text-white">
                      ₹{transportCostPerRm.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} /rm
                    </p>
                  </div>
                )}
                {includeInstallation && installationCostPerRmValue > 0 && (
                  <div>
                    <p className="text-slate-300 text-sm mb-1">Installation Cost</p>
                    <p className="text-xl font-bold text-white">
                      ₹{installationCostPerRmValue.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} /rm
                    </p>
                  </div>
                )}
                {totalCostPerRm !== null && (
                <div className="pt-4 border-t border-white/20 mt-4">
                  <p className="text-slate-300 text-sm mb-2 font-medium">Total Cost per Running Metre</p>
                  <p className="text-3xl font-extrabold text-premium-gold drop-shadow-lg">
                    ₹{totalCostPerRm.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} /rm
                  </p>
                  <p className="text-lg text-premium-gold/90 mt-1">({formatIndianUnits(totalCostPerRm)})</p>
                </div>
                )}
              </div>

              {/* Right Side: Total Cost for Given Quantity */}
              <div className="space-y-4">
                <h4 className="text-xl font-bold text-white mb-4 border-b border-white/20 pb-2">Total Cost for Quantity</h4>
                <div>
                  <label className="block text-sm font-semibold text-slate-200 mb-2">
                    Quantity (Running Metres Required)
                  </label>
                  <input
                    type="number"
                    min="1"
                    value={quantityRm || ''}
                    onChange={(e) => setQuantityRm(e.target.value ? parseFloat(e.target.value) : null)}
                    placeholder="Enter quantity"
                    className="input-premium w-full px-6 py-4 text-white placeholder-slate-400"
                  />
                </div>
                {finalTotal !== null && finalTotal > 0 && (
                  <div className="pt-4 border-t border-white/20 mt-4">
                    <p className="text-slate-300 text-sm mb-2 font-medium">Final Total</p>
                    <p className="text-3xl font-extrabold text-premium-gold drop-shadow-lg">
                      ₹{finalTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                    </p>
                    <p className="text-lg text-premium-gold/90 mt-1">({formatIndianUnits(finalTotal)})</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Download PDF Button */}
        {totalWeight > 0 && ratePerKg !== null && ratePerKg > 0 && (
          <div className="flex justify-center mb-10">
            <button
              onClick={generatePDF}
              className="btn-premium-gold px-12 py-4 text-lg shimmer"
            >
              📄 Download Estimate PDF
            </button>
          </div>
        )}
      </div>
    </div>
  );
}

